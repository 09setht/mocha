
/**
 * Module dependencies.
 */

var EventEmitter = require('events').EventEmitter;

/**
 * Expose `Suite`.
 */

module.exports = Suite;

/**
 * Initialize a new `Suite` with the given `title`.
 *
 * @param {String} title
 * @api private
 */

function Suite(title) {
  this.title = title;
  this.suites = [];
  this.tests = [];
  this.beforeAllCallbacks = [];
  this.beforeEachCallbacks = [];
  this.afterAllCallbacks = [];
  this.afterEachCallbacks = [];
  this.globals = Object.keys(global);
  this.afterEach(this.checkGlobals.bind(this));
}

/**
 * Inherit from `EventEmitter.prototype`.
 */

Suite.prototype.__proto__ = EventEmitter.prototype;

/**
 * Check for global variable leaks.
 *
 * @api private
 */

Suite.prototype.checkGlobals = function(){
  var leaks = Object.keys(global).filter(function(key){
    return !~this.globals.indexOf(key);
  }, this);

  if (leaks.length > 1) {
    throw new Error('global leaks detected: ' + leaks.join(', ') + '');
  } else if (leaks.length) {
    throw new Error('global leak detected: ' + leaks[0]);
  }
};

/**
 * Run `fn(test[, done])` before running tests.
 *
 * @param {Function} fn
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.beforeAll = function(fn){
  this.beforeAllCallbacks.push(fn);
  return this;
}
/**
 * Run `fn(test[, done])` after running tests.
 *
 * @param {Function} fn
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.afterAll = function(fn){
  this.afterAllCallbacks.push(fn);
  return this;
}

/**
 * Run `fn(test[, done])` before each test case.
 *
 * @param {Function} fn
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.beforeEach = function(fn){
  this.beforeEachCallbacks.push(fn);
  return this;
}
/**
 * Run `fn(test[, done])` after each test case.
 *
 * @param {Function} fn
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.afterEach = function(fn){
  this.afterEachCallbacks.push(fn);
  return this;
}

/**
 * Add a test `suite`.
 *
 * @param {Suite} suite
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.addSuite = function(suite){
  suite.parent = this;
  this.suites.push(suite);
  return this;
};

/**
 * Add a `test` to this suite.
 *
 * @param {Test} test
 * @return {Suite} for chaining
 * @api private
 */

Suite.prototype.addTest = function(test){
  test.parent = this;
  this.tests.push(test);
  return this;
};

/**
 * Return the full title generated by recursively
 * concatenating the parent's full title.
 *
 * @return {String}
 * @api public
 */

Suite.prototype.fullTitle = function(){
  if (this.parent) {
    var full = this.parent.fullTitle();
    if (full) return full + ' ' + this.title;
  }
  return this.title;
};

/**
 * Return the total number of tests.
 *
 * @return {Number}
 * @api public
 */

Suite.prototype.total = function(){
  return this.suites.reduce(function(sum, suite){
    return sum + suite.total();
  }, 0) + this.tests.length;
};
